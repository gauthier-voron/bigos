#!/usr/bin/perl -wl
use strict;

my $NAME = shift;
my @EVENTS = @ARGV;
my ($me, $log, $pid);
my @command;
my %values;

# Check if no name is given
$NAME || exit 1;

# Check is root
$me = `whoami`;
chomp $me;
$me eq 'root' or exit 1;

# Prepare the log and pid files
open $pid, '>', "$NAME.pid" || exit 1;
print $pid $$;
close $pid;

@command = qw(operf --system-wide);
foreach (@EVENTS) {
    push @command, '-e';
    push @command, $_;
}

$pid = fork;
unless ($pid) {
    exec @command;
}

$SIG{INT} = sub { kill 'INT', $pid };
$SIG{QUIT} = sub { kill 'INT', $pid };
$SIG{TERM} = sub { kill 'INT', $pid };
waitpid $pid, 0;

open $log, '>', "$NAME.log";
my ($binary, $count, $val);
foreach (split "\n", `opreport --xml`) {
    if (/^<binary\s+name="(.*)">$/) {
        $binary = $1;
    } elsif ($binary && /^<count.*>$/) {
        $count = 1;
    } elsif ($count && /^(\d+)<\/count>$/) {
        $val = $1;
        push @{$values{$binary}}, $val;
    } else {
        $binary = '';
        $count = '';
        $val = '';
    }
}
foreach (keys %values) {
    my $i = 0;
    my $bin = $_;
    foreach (@{$values{$bin}}) {
        printf $log $bin . "($i) ";
        $i++;
    }
}
print $log '';

foreach (keys %values) {
    foreach (@{$values{$_}}) {
        printf $log $_ . ' ';
    }
}
print $log '';


close $log;
`rm -rf oprofile_data`
