#!/usr/bin/perl -wl
use strict;

my $NAME = shift;
my ($pid, $fd);
my ($time, @fields, $i);

# Check if no name is given
$NAME || exit 1;

# Prepare the log and pid files
open $pid, '>', "$NAME.pid" || exit 1;
print $pid $$;
close $pid;

# Do the measure
foreach (split "\n", `numastat -m | tail -n +3`) {
    unless (@fields) {
	@fields = map { s/\s/_/g ; $_ } (split /\s{3,}/, $_);
	shift @fields;
    }

    /^(\w+)\s+\d+/ or next;
    open $fd, '>', "$NAME-$1.log" || exit 1;

    printf $fd '#time';
    $i = 0;
    foreach (split /\s+/, $_) {
	next unless (/^\d/);
	printf $fd ' ' . $fields[$i++];
    }
    print $fd '';

    close $fd;
}

$time = 0;
while (1) {
    sleep 1;
    $time++;

    foreach (split "\n", `numastat -m`) {
	/^(\w+)\s+\d+/ or next;
	open $fd, '>>', "$NAME-$1.log" || exit 1;

	printf $fd $time;

	foreach (split /\s+/, $_) {
	    next unless (/^\d/);
	    printf $fd ' ' . $_;
	}
	print $fd '';

	close $fd;
    }
}
