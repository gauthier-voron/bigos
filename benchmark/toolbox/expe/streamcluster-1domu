#!/bin/sh

error() {
    MSG=$1; shift
    echo "$0: $MSG" 1>&2
    exit 1
}

VMBASE=vm
VMNAME=xen-vm-0
RESULTS=`date +'%Y-%m-%d-%H-%M-%S'`

mkdir "$RESULTS" || error "cannot mkdir '$RESULTS'"
mkdir "$RESULTS/tools" || exit 1

build-streamcluster "$RESULTS/parsec" || exit 1
cp `which streamcluster` "$RESULTS/tools"
cp `which cpurate` "$RESULTS/tools"
cp `which memrate` "$RESULTS/tools"

if [ ! -e "$VMBASE" ] ; then
    xen-create "$VMBASE" || exit 1
fi

xen-clone "$VMBASE" "$VMNAME" || exit 1
xen-set-home "$VMNAME" "$RESULTS" || exit 1
xen-boot "$VMNAME"
xen-login "$VMNAME"

(
    echo 'cd /home'
    echo 'PATH=$PATH:$PWD/tools'
    echo 'cpurate cpu streamcluster &'
    echo 'memrate mem streamcluster &'
    echo 'streamcluster parsec'
    echo 'kill `cat cpu.pid`'
    echo 'kill `cat mem.pid`'
    echo 'rm cpu.pid'
    echo 'rm mem.pid'
    echo 'sync'
) | xen-command "$VMNAME"

xen-shutdown "$VMNAME"

xen-get-home "$VMNAME" "$RESULTS" || exit 1
rm -rf "$VMNAME"
