#!/bin/sh
# Run dc on a native Linux with all machine resources.

error() {
    MSG=$1; shift
    echo "$0: $MSG" 1>&2
    exit 1
}

RESULTS=dc-interl.`date +'%Y-%m-%d-%H-%M-%S'`

mkdir "$RESULTS" || error "cannot mkdir '$RESULTS'"
mkdir "$RESULTS/log" || error "cannot mkdir '$RESULTS/logs'"
build-dc "$RESULTS/npb" || exit 1

cd "$RESULTS"
cpurate log/cpu dc &
memrate log/mem dc &
numamem log/numa &
oproperf log/oprof dc CPU_IO_REQUESTS_TO_MEMORY_IO:2500:0xa8 CPU_IO_REQUESTS_TO_MEMORY_IO:2500:0x98 &
numactl --interleave=all dc npb
kill `cat log/cpu.pid`
kill `cat log/mem.pid`
kill `cat log/numa.pid`
kill `cat log/oprof.pid`
rm log/cpu.pid
rm log/mem.pid
rm log/numa.pid
rm log/oprof.pid

while pgrep oproperf ; do
    sleep 1
done

mv `find npb/ -name "*.log"` log

mv log/* .
rm -rf npb
rmdir log
